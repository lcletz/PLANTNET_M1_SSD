---
title: "Mutliple_data_analyses"
author: "AIGOIN Emilie"
date: "2025-02-16"
output: html_document
---

```{r}

# Fonction pour traiter un fichier JSON individuel
process_single_json <- function(file_path) {
  # Lire le fichier JSON
  json_data <- tryCatch(
    fromJSON(file_path),
    error = function(e) {
      warning(paste("Erreur lors de la lecture du fichier:", file_path))
      return(NULL)
    }
  )
  
  if (is.null(json_data) || is.null(json_data$results) || length(json_data$results) == 0) return(NULL)
  
  # Extraire l'ID de l'observation depuis le nom du fichier
  obs_id <- tools::file_path_sans_ext(basename(file_path))
  
  # Extraire les prédictions et scores sous la forme id: score
  results <- json_data$results
  predictions <- setNames(results$score, as.character(results$id))
  
  # Convertir les résultats pour que l'id soit visible dans la structure finale
  formatted_predictions <- paste(names(predictions), predictions, sep=": ")
  
  return(list(
    obs_id = obs_id,
    predictions = formatted_predictions
  ))
}

# Fonction principale
process_plant_data <- function(base_dir = "00", 
                               output_path = "output_test.json") {
  
  # Lister tous les sous-dossiers dans le dossier 00
  subdirs <- list.files(base_dir, full.names = TRUE)
  
  # Initialiser une liste vide pour stocker les résultats
  all_results <- list()
  files_processed <- 0  # Compteur pour limiter le nombre total de fichiers traités
  
  # Pour chaque sous-dossier
  for (subdir in subdirs) {
    # Lister tous les fichiers JSON dans le sous-dossier
    json_files <- list.files(subdir, pattern = "\\.json$", full.names = TRUE)
    
    # Traiter chaque fichier JSON
    results <- map(json_files, process_single_json)
    
    # Filtrer les résultats NULL
    results <- results[!sapply(results, is.null)]
    
    # Ajouter à nos résultats globaux
    if (length(results) > 0) {
      all_results <- c(all_results, results)
    }
    
    # Mettre à jour le compteur
    files_processed <- files_processed + length(json_files)
    
    # Afficher la progression
    cat(sprintf("Traitement du dossier %s terminé (%d fichiers traités)\n", 
                basename(subdir), length(json_files)))
    
  }
  
  # Vérifier si des résultats ont été collectés
  if (length(all_results) == 0) {
    cat("Aucun fichier JSON valide n'a été traité.\n")
    return(NULL)
  }
  
  # Créer la structure finale : { "nom_fichier" : [id1: score1, id2: score2, ...] }
  final_results <- setNames(
    map(all_results, ~.x$predictions),
    map_chr(all_results, ~.x$obs_id)
  )
  
  # Sauvegarder le résultat sous la forme JSON
  write_json(final_results, output_path, auto_unbox = TRUE, pretty = TRUE)
  
  return(final_results)
}

# Tester avec un petit échantillon
results <- process_plant_data(
  base_dir = "00",              
  output_path = "output_test.json"
)

# Vérifier les résultats
if (!is.null(results)) {
  cat("Nombre total d'observations traitées:", length(results), "\n")
  cat("Exemple de la première observation:\n")
  print(results[[1]])
}

```

```















