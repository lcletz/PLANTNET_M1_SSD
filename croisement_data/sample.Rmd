---
title: "Test"
author: "AIGOIN Emilie"
date: "2025-03-10"
output: html_document
---

Récupérer les données de sample et les croiser avec classes pour avoir l'ID

```{r}

# Import required packages
library(jsonlite)
library(purrr)

# Définir le chemin exact vers votre dossier
chemin_exact <- "/Users/emilieaigoin/Desktop/multiple_data"

# Changer le répertoire de travail vers ce dossier
setwd(chemin_exact)

# Afficher le répertoire de travail pour confirmation
cat("Répertoire de travail actuel:", getwd(), "\n")

# Vérifier si le dossier "00" existe dans ce répertoire
if (!dir.exists("00")) {
  cat("Le dossier '00' n'existe pas dans", getwd(), "\n")
  cat("Contenu du répertoire actuel:", paste(list.files(), collapse=", "), "\n")
  stop("Dossier '00' introuvable. Vérifiez le chemin.")
}

# Fonction pour traiter un fichier JSON
process_single_json <- function(file_path) {
  # Lire le fichier JSON
  json_data <- tryCatch(
    fromJSON(file_path),
    error = function(e) {
      warning(paste("Erreur lors de la lecture du fichier:", file_path))
      return(NULL)
    }
  )
  
  # Vérifier si les données JSON sont valides et contiennent des résultats
  if (is.null(json_data) || 
      is.null(json_data$results) || 
      length(json_data$results) == 0) 
    return(NULL)
  
  # Extraire l'ID d'observation du nom du fichier
  obs_id <- tools::file_path_sans_ext(basename(file_path))
  
  # Extraire les noms et scores des résultats
  results <- json_data$results
  
  # Créer une liste de prédictions où les noms sont les noms de plantes et les valeurs sont les scores
  predictions <- setNames(results$score, results$name)
  
  # Retourner un objet contenant l'ID d'observation et les prédictions
  return(list(
    obs_id = obs_id,
    predictions = predictions
  ))
}

# Fonction principale pour traiter les données de plantes
process_plant_data <- function() {
  # Lister tous les sous-répertoires dans le répertoire "00"
  subdirs <- list.files("00", full.names = TRUE)
  cat("Sous-répertoires trouvés:", length(subdirs), "\n")
  
  # Initialiser une liste vide pour stocker les résultats
  all_results <- list()
  
  # Pour chaque sous-répertoire
  for (subdir in subdirs) {
    # Lister tous les fichiers JSON dans le sous-répertoire
    json_files <- list.files(subdir, pattern = "\\.json$", full.names = TRUE)
    
    # Traiter chaque fichier JSON
    results <- map(json_files, process_single_json)
    
    # Filtrer les résultats NULL
    results <- results[!sapply(results, is.null)]
    
    # Ajouter les résultats valides à la liste de résultats globale
    if (length(results) > 0) {
      all_results <- c(all_results, results)
    }
    
    # Afficher la progression
    cat(sprintf("Traitement du dossier %s terminé (%d fichiers traités)\n", 
                basename(subdir), length(json_files)))
  }
  
  # Vérifier si des résultats ont été collectés
  if (length(all_results) == 0) {
    cat("Aucun fichier JSON valide n'a été traité.\n")
    return(NULL)
  }
  
  # Créer la structure finale : { "nom_fichier" : {"nom_plante": score, ...} }
  final_results <- setNames(
    map(all_results, ~.x$predictions),
    map_chr(all_results, ~.x$obs_id)
  )
  
  # Sauvegarder les résultats finaux sous forme de fichier JSON
  output_path <- "resultats_plantes.json"
  write_json(final_results, output_path, auto_unbox = TRUE, pretty = TRUE)
  
  # Vérifier que le fichier a été créé avec succès
  if (file.exists(output_path)) {
    cat("SUCCÈS: Fichier créé avec succès à:", normalizePath(output_path), "\n")
    cat("Taille du fichier:", file.info(output_path)$size, "octets\n")
  } else {
    cat("ERREUR: Le fichier n'a pas été créé.\n")
  }
  
  # Retourner les résultats
  return(final_results)
}

# Exécuter la fonction
results <- process_plant_data()

# Vérifier les résultats
if (!is.null(results)) {
  # Afficher le nombre total d'observations traitées
  cat("Nombre total d'observations traitées:", length(results), "\n")
  
  # Afficher un exemple de la première observation
  cat("Exemple de la première observation:\n")
  print(head(results, 1))
}

```

```{r}

# Import required packages
library(jsonlite)
library(purrr)

# Définir le chemin exact vers votre dossier
chemin_exact <- "/Users/emilieaigoin/Desktop/multiple_data"

# Changer le répertoire de travail vers ce dossier
setwd(chemin_exact)

# Afficher le répertoire de travail pour confirmation
cat("Répertoire de travail actuel:", getwd(), "\n")

# Vérifier si le dossier "00" existe dans ce répertoire
if (!dir.exists("00")) {
  cat("Le dossier '00' n'existe pas dans", getwd(), "\n")
  cat("Contenu du répertoire actuel:", paste(list.files(), collapse=", "), "\n")
  stop("Dossier '00' introuvable. Vérifiez le chemin.")
}

# Fonction pour traiter un fichier JSON
process_single_json <- function(file_path) {
  # Lire le fichier JSON
  json_data <- tryCatch(
    fromJSON(file_path),
    error = function(e) {
      warning(paste("Erreur lors de la lecture du fichier:", file_path))
      return(NULL)
    }
  )
  
  # Vérifier si les données JSON sont valides et contiennent des résultats
  if (is.null(json_data) || 
      is.null(json_data$results) || 
      length(json_data$results) == 0) 
    return(NULL)
  
  # Extraire l'ID d'observation du nom du fichier
  obs_id <- tools::file_path_sans_ext(basename(file_path))
  
  # Extraire les résultats
  results <- json_data$results
  
  # Créer une liste associant noms de plantes et scores
  # Format: "nom plante (id)": score
  predictions <- list()
  for (i in 1:length(results$name)) {
    plant_key <- paste0(results$name[i], " (", results$id[i], ")")
    predictions[[plant_key]] <- results$score[i]
  }
  
  # Retourner un objet contenant l'ID d'observation et les prédictions
  return(list(
    obs_id = obs_id,
    predictions = predictions
  ))
}

# # Fonction principale pour traiter les données de plantes
# process_plant_data <- function() {
#   # Lister tous les sous-répertoires dans le répertoire "00"
#   subdirs <- list.files("00", full.names = TRUE)
#   cat("Sous-répertoires trouvés:", length(subdirs), "\n")
#   
#   # Initialiser une liste vide pour stocker les résultats
#   all_results <- list()
#   
#   # Pour chaque sous-répertoire
#   for (subdir in subdirs) {
#     # Lister tous les fichiers JSON dans le sous-répertoire
#     json_files <- list.files(subdir, pattern = "\\.json$", full.names = TRUE)
#     
#     # Traiter chaque fichier JSON
#     results <- map(json_files, process_single_json)
#     
#     # Filtrer les résultats NULL
#     results <- results[!sapply(results, is.null)]
#     
#     # Ajouter les résultats valides à la liste de résultats globale
#     if (length(results) > 0) {
#       all_results <- c(all_results, results)
#     }
#     
#     # Afficher la progression
#     cat(sprintf("Traitement du dossier %s terminé (%d fichiers traités)\n", 
#                 basename(subdir), length(json_files)))
#   }
#   
#   # Vérifier si des résultats ont été collectés
#   if (length(all_results) == 0) {
#     cat("Aucun fichier JSON valide n'a été traité.\n")
#     return(NULL)
#   }
#   
#   # Créer la structure finale : { "nom_fichier" : {"nom_plante (id)": score, ...} }
#   final_results <- setNames(
#     map(all_results, ~.x$predictions),
#     map_chr(all_results, ~.x$obs_id)
#   )
#   
#   # Sauvegarder les résultats finaux sous forme de fichier JSON
#   output_path <- "resultats_plantes_complet.json"
#   write_json(final_results, output_path, auto_unbox = TRUE, pretty = TRUE)
#   
#   # Vérifier que le fichier a été créé avec succès
#   if (file.exists(output_path)) {
#     cat("SUCCÈS: Fichier créé avec succès à:", normalizePath(output_path), "\n")
#     cat("Taille du fichier:", file.info(output_path)$size, "octets\n")
#   } else {
#     cat("ERREUR: Le fichier n'a pas été créé.\n")
#   }
#   
#   # Retourner les résultats
#   return(final_results)
# }

# Fonction alternative qui crée une structure avec noms et IDs séparés
process_plant_data_advanced <- function() {
  # Lister tous les sous-répertoires dans le répertoire "00"
  subdirs <- list.files("00", full.names = TRUE)
  cat("Sous-répertoires trouvés:", length(subdirs), "\n")
  
  # Initialiser une liste vide pour stocker les résultats
  all_results <- list()
  
  # Pour chaque sous-répertoire
  for (subdir in subdirs) {
    # Lister tous les fichiers JSON dans le sous-répertoire
    json_files <- list.files(subdir, pattern = "\\.json$", full.names = TRUE)
    
    for (file_path in json_files) {
      # Lire le fichier JSON
      json_data <- tryCatch(
        fromJSON(file_path),
        error = function(e) {
          warning(paste("Erreur lors de la lecture du fichier:", file_path))
          next
        }
      )
      
      # Vérifier si les données JSON sont valides et contiennent des résultats
      if (is.null(json_data) || 
          is.null(json_data$results) || 
          length(json_data$results) == 0) 
        next
      
      # Extraire l'ID d'observation du nom du fichier
      obs_id <- tools::file_path_sans_ext(basename(file_path))
      
      # Créer une liste de noms et probabilités
      result <- list()
      for (i in 1:length(json_data$results$name)) {
        entry <- list(
          name = json_data$results$name[i],
          id = json_data$results$id[i],
          score = json_data$results$score[i]
        )
        result[[i]] <- entry
      }
      
      # Ajouter cette observation aux résultats
      all_results[[obs_id]] <- result
    }
    
    # Afficher la progression
    cat(sprintf("Traitement du dossier %s terminé (%d fichiers traités)\n", 
                basename(subdir), length(json_files)))
  }
  
  # Vérifier si des résultats ont été collectés
  if (length(all_results) == 0) {
    cat("Aucun fichier JSON valide n'a été traité.\n")
    return(NULL)
  }
  
  # Sauvegarder les résultats finaux sous forme de fichier JSON
  output_path <- "resultats_plantes_avance.json"
  write_json(all_results, output_path, auto_unbox = TRUE, pretty = TRUE)
  
  cat("SUCCÈS: Fichier créé avec succès à:", normalizePath(output_path), "\n")
  
  # Retourner les résultats
  return(all_results)
}

# Exécuter les deux fonctions
# cat("\n--- CRÉATION DU FICHIER FORMAT SIMPLE ---\n")
# results1 <- process_plant_data()

cat("\n--- CRÉATION DU FICHIER FORMAT AVANCÉ ---\n")
results2 <- process_plant_data_advanced()

# Afficher un résumé
cat("\nDeux fichiers ont été créés dans", getwd(), ":\n")
# cat("1. resultats_plantes_complet.json - Format simple avec noms et IDs combinés\n")
cat("2. resultats_plantes_avance.json - Format avancé avec structure complète\n")

```

```{r}

# Charger la bibliothèque jsonlite pour manipuler les fichiers JSON
library(jsonlite)

# Lire les fichiers JSON (remplacez par vos chemins de fichiers réels)
premier_fichier <- fromJSON("/Users/emilieaigoin/Desktop/multiple_data/resultats_plantes_avance.json", simplifyDataFrame = FALSE)
deuxieme_fichier <- fromJSON("/Users/emilieaigoin/Desktop/multiple_data/ai_classes.json")

# Création d'une fonction pour traiter chaque observation
enrichir_observation <- function(observation) {
  # observation est une liste d'espèces prédites
  for (i in 1:length(observation)) {
    # Obtenir le nom de l'espèce
    nom_espece <- observation[[i]]$name
    
    # Vérifier si le nom existe dans le deuxième fichier
    if (nom_espece %in% names(deuxieme_fichier)) {
      # Si oui, ajouter l'identifiant
      observation[[i]]$second_id <- deuxieme_fichier[[nom_espece]]
    } else {
      # Sinon, ajouter NA
      observation[[i]]$second_id <- NA
    }
  }
  
  return(observation)
}

# Traitement de chaque observation dans le premier fichier
resultat <- list()
for (id_obs in names(premier_fichier)) {
  # Appliquer la fonction d'enrichissement à cette observation
  resultat[[id_obs]] <- enrichir_observation(premier_fichier[[id_obs]])
}

# Sauvegarder le résultat dans un nouveau fichier JSON
write_json(resultat, "/Users/emilieaigoin/Desktop/multiple_data/resultat_enrichi.json", pretty = TRUE, auto_unbox = TRUE)

cat("Fichier enrichi créé avec succès !\n")

```




